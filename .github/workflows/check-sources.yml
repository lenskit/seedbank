name: Validate Source Rules
on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: check-${{github.ref}}
  cancel-in-progress: true

jobs:
  lint:
    name: Check Source Code
    runs-on: ubuntu-latest

    steps:
      - name: üì• Check out source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
          cache: "pip"

      - name: üõ†Ô∏è Install development tools and dependencies
        run: |
          pip install -e .[dev]

      - name: ü™Æ Check source code formatting
        id: format
        run: |
          if ruff format --diff $PKG_DIR; then
            echo passed=yes >>"$GITHUB_OUTPUT"
          else
            echo passed=no >>"$GITHUB_OUTPUT"
            echo "::error::source code not formatted"
          fi
        env:
          PKG_DIR: seedbank

      - name: üêú Check source code lint rules
        id: lint
        run: |
          if ruff check --output-format=github $PKG_DIR; then
            echo passed=yes >>"$GITHUB_OUTPUT"
          else
            echo passed=no >>"$GITHUB_OUTPUT"
            echo "::error::source code lint check failed"
          fi
        env:
          PKG_DIR: seedbank

      - name: üßæ Checking lint and format results
        run: |
          if [ "$FMT_PASSED" = no ]; then
              echo "::error::format failed, failing build"
              exit 1
          fi
          if [ "$LINT_PASSED" = no ]; then
              if [ "$LINT_REQUIRED" = true ]; then
                  echo "::error::lint failed, failing build"
                  exit 2
              else
                  echo "::error::lint failed but non-mandatory"
              fi
          fi
        env:
          FMT_PASSED: ${{ steps.format.outputs.passed }}
          LINT_PASSED: ${{ steps.lint.outputs.passed }}
          LINT_REQUIRED: True


      - name: üìê Check types
        id: typecheck
        uses: jakebailey/pyright-action@v1
        with:
          extra-args: seedbank

